#!/bin/bash

CONFIG_FILE_NAME="/etc/mcloud-config/mcloud-server.conf"

CONFIG_CONTENTS=`cat $CONFIG_FILE_NAME`

if [ ! -f $CONFIG_FILE_NAME ]; then
			echo "ERROR: MCLOUD_CONFIG_SERVER file does not exists, please run setup first."
			exit 1;
fi

eval $CONFIG_CONTENTS

echo "Use this script as /usr/bin/mcloud-user-addition REPO_NAME LIST_OF_USERS_SEPERATED_BY;"
echo "Or open and follow steps"
echo "Warning, this script must be run as root, or use the sudoers script"
echo "Warning, git repo must be in the top level directory of the main git central"
if [ -z $1 ]
then
	echo "Name of the repo"
	read REPO_NAME
else
	REPO_NAME=$1
fi

if [ -z $2 ]
then
	echo "Users, seperated by ; without spaces"
	read USERS
else
	USERS=$2
fi

echo "Creating new user group"
groupadd group_$REPO_NAME

export IFS=";"

for user in $USERS; do
	echo "Addinng user: $user to new group"
  usermod -G group_$REPO_NAME $user;
done

echo "Creating shared folder"
mkdir -p $LOCATION_MOUNTPOINT/$REPO_NAME

echo "Assigning group to shared folder"
chgrp -R group_$REPO_NAME $LOCATION_MOUNTPOINT/$REPO_NAME

echo "Chmodding location"
chmod 770 -R $LOCATION_MOUNTPOINT/$REPO_NAME

echo "Script is finished, please tell the others!"
